<?php

/**
 * Plugin Name: Hi-Hat Repeater
 * Plugin URI:  https://github.com/yourusername/hi-hat-repeater
 * Description: An Advanced Custom Fields add-on for a repeater-like field with multiple text areas. Includes GraphQL support.
 * Version:     1.2.1
 * Author:      Your Name
 * Author URI:  https://github.com/yourusername
 * License:     GPL-2.0-or-later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: hi-hat-repeater
 * Requires at least: 5.0
 * Tested up to: 6.4
 * Requires PHP: 7.4
 * ACF: 5.0.0
 */

// Exit if accessed directly.
if (! defined('ABSPATH')) {
	exit;
}

// Check if ACF is active.
if (! class_exists('acf')) {
	return;
}



// Define constants.
if (!defined('HI_HAT_REPEATER_URL')) {
	define('HI_HAT_REPEATER_URL', plugin_dir_url(__FILE__));
}
if (!defined('HI_HAT_REPEATER_PATH')) {
	define('HI_HAT_REPEATER_PATH', plugin_dir_path(__FILE__));
}

// Register GraphQL support for WPGraphQL ACF as early as possible
add_action('wpgraphql/acf/init', function () {
	if (function_exists('register_graphql_acf_field_type')) {
		register_graphql_acf_field_type('hi_hat_repeater_textarea', [
			'graphql_type' => ['list_of' => 'String']
		]);
		register_graphql_acf_field_type('hi_hat_repeater_image', [
			'graphql_type' => ['list_of' => 'MediaItem']
		]);
		// Register the hi_hat_repeater_group field type
		// This behaves like ACF's repeater with sub_fields
		register_graphql_acf_field_type('hi_hat_repeater_group', [
			'graphql_type' => function ($field_config, $acf_field_type) {
				$sub_field_group = $field_config->get_acf_field();
				$parent_type     = $field_config->get_parent_graphql_type_name($sub_field_group);
				$field_name      = $field_config->get_graphql_field_name();

				// Use WPGraphQL's Utils class if available, otherwise format manually
				if (class_exists('\WPGraphQL\Utils\Utils')) {
					$type_name = \WPGraphQL\Utils\Utils::format_type_name($parent_type . ' ' . $field_name);
				} else {
					// Fallback: simple format conversion
					$type_name = ucfirst($parent_type) . ucfirst($field_name);
				}

				$sub_field_group['graphql_type_name']  = $type_name;
				$sub_field_group['graphql_field_name'] = $type_name;
				$sub_field_group['locations']          = null;

				// Register the sub fields as a GraphQL type
				$field_config->get_registry()->register_acf_field_groups_to_graphql(
					[$sub_field_group]
				);

				return ['list_of' => $type_name];
			}
		]);
	}
});



// Register GraphQL support for WPGraphQL ACF as early as possible
add_action('wpgraphql/acf/init', function () {
	if (function_exists('register_graphql_acf_field_type')) {
		register_graphql_acf_field_type('hi_hat_repeater_textarea', [
			'graphql_type' => ['list_of' => 'String']
		]);
		register_graphql_acf_field_type('hi_hat_repeater_image', [
			'graphql_type' => ['list_of' => 'MediaItem']
		]);
		// Register the hi_hat_repeater_group field type
		// This behaves like ACF's repeater with sub_fields
		register_graphql_acf_field_type('hi_hat_repeater_group', [
			'graphql_type' => function ($field_config, $acf_field_type) {
				$sub_field_group = $field_config->get_acf_field();
				$parent_type     = $field_config->get_parent_graphql_type_name($sub_field_group);
				$field_name      = $field_config->get_graphql_field_name();

				// Use WPGraphQL's Utils class if available, otherwise format manually
				if (class_exists('\WPGraphQL\Utils\Utils')) {
					$type_name = \WPGraphQL\Utils\Utils::format_type_name($parent_type . ' ' . $field_name);
				} else {
					// Fallback: simple format conversion
					$type_name = ucfirst($parent_type) . ucfirst($field_name);
				}

				$sub_field_group['graphql_type_name']  = $type_name;
				$sub_field_group['graphql_field_name'] = $type_name;
				$sub_field_group['locations']          = null;

				// Register the sub fields as a GraphQL type
				$field_config->get_registry()->register_acf_field_groups_to_graphql(
					[$sub_field_group]
				);

				return ['list_of' => $type_name];
			}
		]);
	}
});

// Handle field value resolution using the standard WPGraphQL ACF filter
add_filter('wpgraphql/acf/field_value', function ($value, $field_config, $root, $node_id) {
	if (isset($field_config['type'])) {
		if ($field_config['type'] === 'hi_hat_repeater_textarea') {
			// Get the raw field value from ACF using the field name
			$raw_value = get_field($field_config['name'], $node_id, false);
			if (is_array($raw_value)) {
				// Filter out empty values, including empty HTML
				return array_filter($raw_value, function ($item) {
					if (! is_string($item)) {
						return false;
					}

					// Strip HTML tags and check if there's actual content
					$content = wp_strip_all_tags($item);
					$content = trim($content);

					return strlen($content) > 0;
				});
			}
			return [];
		} elseif ($field_config['type'] === 'hi_hat_repeater_image') {
			// Get the raw field value from ACF using the field name
			$raw_value = get_field($field_config['name'], $node_id, false);
			if (! is_array($raw_value)) {
				return [];
			}

			$result = array();
			foreach ($raw_value as $attachment_id) {
				$attachment_id = absint($attachment_id);
				if (! $attachment_id) {
					continue;
				}

				$attachment = get_post($attachment_id);
				if (! $attachment || 'attachment' !== $attachment->post_type) {
					continue;
				}

				// Get image data
				$image_url = wp_get_attachment_image_url($attachment_id, 'full');
				$image_alt = get_post_meta($attachment_id, '_wp_attachment_image_alt', true);
				$image_title = get_the_title($attachment_id);

				// Get additional metadata
				$metadata = wp_get_attachment_metadata($attachment_id);
				$width = isset($metadata['width']) ? $metadata['width'] : null;
				$height = isset($metadata['height']) ? $metadata['height'] : null;

				$result[] = array(
					'id'     => $attachment_id,
					'url'    => $image_url ? $image_url : '',
					'alt'    => $image_alt ? $image_alt : '',
					'title'  => $image_title ? $image_title : '',
					'width'  => $width,
					'height' => $height,
				);
			}

			return $result;
		}
	}
	return $value;
}, 10, 4);

// Ensure ACF field groups show in GraphQL
add_filter('wpgraphql/acf/should_field_group_show_in_graphql', function ($should, $acf_field_group) {
	// Force field groups to show in GraphQL if they contain hi-hat repeater fields
	if (isset($acf_field_group['fields']) && is_array($acf_field_group['fields'])) {
		foreach ($acf_field_group['fields'] as $field) {
			if (isset($field['type']) && ($field['type'] === 'hi_hat_repeater_textarea' || $field['type'] === 'hi_hat_repeater_image')) {
				return true;
			}
		}
	}
	return $should;
}, 10, 2);

/**
 * Include the new field types.
 *
 * @param int $version The ACF version.
 */
function include_field_types_hi_hat_repeater($version)
{
	$debug_file = __DIR__ . '/debug.log';
	file_put_contents($debug_file, date('Y-m-d H:i:s') . " - include_field_types_hi_hat_repeater called\n", FILE_APPEND);

	// Force an admin notice to prove this runs
	add_action('admin_notices', function () {
		echo '<div class="notice notice-warning"><p>HI-HAT DEBUG: include_field_types_hi_hat_repeater was called!</p></div>';
	});

	include_once 'fields/class-hi-hat-repeater-field-base.php';
	include_once 'fields/class-hi-hat-repeater-field-textarea.php';
	include_once 'fields/class-hi-hat-repeater-field-image.php';
	include_once 'fields/class-acf-field-hi-hat-repeater-group.php';

	file_put_contents($debug_file, date('Y-m-d H:i:s') . " - Files included\n", FILE_APPEND);

	// Register the field types with ACF
	acf_register_field_type(new Hi_Hat_Repeater_Field_Textarea());
	file_put_contents($debug_file, date('Y-m-d H:i:s') . " - Textarea registered\n", FILE_APPEND);

	acf_register_field_type(new Hi_Hat_Repeater_Field_Image());
	file_put_contents($debug_file, date('Y-m-d H:i:s') . " - Image registered\n", FILE_APPEND);

	try {
		$group_field = new acf_field_hi_hat_repeater_group();
		acf_register_field_type($group_field);
		file_put_contents($debug_file, date('Y-m-d H:i:s') . " - Group registered successfully\n", FILE_APPEND);
	} catch (Exception $e) {
		file_put_contents($debug_file, date('Y-m-d H:i:s') . " - ERROR registering group: " . $e->getMessage() . "\n", FILE_APPEND);
	}
}

add_action('acf/include_field_types', 'include_field_types_hi_hat_repeater');

// Debug: log that we got here
$debug_file = __DIR__ . '/debug.log';
file_put_contents($debug_file, date('Y-m-d H:i:s') . " - Plugin loaded, action added\n", FILE_APPEND);

/**
 * Enqueue admin styles for the hi-hat repeater field.
 */
function enqueue_hi_hat_repeater_admin_styles()
{
	wp_enqueue_style(
		'hi-hat-repeater-admin',
		HI_HAT_REPEATER_URL . 'css/hi-hat-repeater-admin.css',
		array(),
		'1.0.0'
	);
	wp_enqueue_script(
		'hi-hat-repeater-admin',
		HI_HAT_REPEATER_URL . 'js/hi-hat-repeater-admin.js',
		array('jquery', 'acf-input', 'media-editor'),
		'1.0.0',
		true
	);
}

add_action('admin_enqueue_scripts', 'enqueue_hi_hat_repeater_admin_styles');
